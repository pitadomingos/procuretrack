module.exports = {

"[project]/.next-internal/server/app/api/requisitions/route/actions.js [app-rsc] (server actions loader, ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({});
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/@opentelemetry/api [external] (@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@opentelemetry/api", () => require("@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/process [external] (process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[externals]/timers [external] (timers, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("timers", () => require("timers"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/string_decoder [external] (string_decoder, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("string_decoder", () => require("string_decoder"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[project]/backend/db.js [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "pool": (()=>pool)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/mysql2/promise.js [app-route] (ecmascript)");
;
// Check for essential DB environment variables
const essentialEnvVars = [
    'DB_HOST',
    'DB_USER',
    'DB_PASSWORD',
    'DB_NAME'
];
const missingEnvVars = essentialEnvVars.filter((v)=>!process.env[v]);
if (missingEnvVars.length > 0) {
    const errorMessage = `CRITICAL_DB_INIT_ERROR: Missing essential database environment variables: ${missingEnvVars.join(', ')}. Please define these in your root .env file. Database connections will fail until this is resolved.`;
    console.error(errorMessage);
    throw new Error(errorMessage);
}
// The CA certificate content is now expected to be in an environment variable.
const caCert = process.env.DB_SSL_CA;
if (!caCert) {
    console.warn(`DB_WARN: The DB_SSL_CA environment variable is not set. Database connections may fail if SSL is required by your provider. For local development without SSL, this may be ignored.`);
}
let pool;
try {
    pool = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createPool({
        host: process.env.DB_HOST,
        user: process.env.DB_USER,
        password: process.env.DB_PASSWORD,
        database: process.env.DB_NAME,
        port: process.env.DB_PORT ? parseInt(process.env.DB_PORT, 10) : 3306,
        // Conditionally add SSL options only if the certificate is provided.
        ...caCert && {
            ssl: {
                ca: caCert,
                rejectUnauthorized: true
            }
        },
        waitForConnections: true,
        connectionLimit: 10,
        queueLimit: 0
    });
    console.log("DB_INIT_SUCCESS: MySQL connection pool created (this does not guarantee successful connection yet, but configuration is loaded).");
} catch (error) {
    console.error(`CRITICAL_DB_INIT_ERROR: Failed to create MySQL connection pool: ${error.message}. This is a fatal error for database operations.`);
    throw new Error(`Failed to initialize database connection pool due to: ${error.message}. Review DB environment variables.`);
}
;
}}),
"[project]/src/app/api/requisitions/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "GET": (()=>GET),
    "POST": (()=>POST)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/backend/db.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/crypto [external] (crypto, cjs)");
;
;
;
const safeToISOString = (dateValue)=>{
    if (!dateValue) return null;
    const dateObj = new Date(dateValue);
    if (isNaN(dateObj.getTime())) {
        console.warn(`[API WARN] Invalid date value encountered: ${dateValue}. Returning null.`);
        return null;
    }
    return dateObj.toISOString();
};
async function POST(request) {
    let connection;
    try {
        const requisitionData = await request.json(); // siteId (header) is now expected to be number
        const generatedId = requisitionData.id || (0, __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__["randomUUID"])();
        // Validate header siteId
        if (!requisitionData.siteId) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Site/Department is required for the requisition header.'
            }, {
                status: 400
            });
        }
        if (!requisitionData.requisitionNumber || !requisitionData.requisitionDate || !requisitionData.requestedByName) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Missing required fields for requisition header (Req No, Date, Requested By).'
            }, {
                status: 400
            });
        }
        if (!requisitionData.items || requisitionData.items.length === 0) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Requisition must have at least one item.'
            }, {
                status: 400
            });
        }
        connection = await __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["pool"].getConnection();
        await connection.beginTransaction();
        const statusToSave = requisitionData.approverId ? 'Pending Approval' : 'Draft';
        // Header justification field removed from INSERT
        await connection.execute(`INSERT INTO Requisition (id, requisitionNumber, requisitionDate, requestedByUserId, requestedByName, siteId, status, approverId, createdAt, updatedAt)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`, [
            generatedId,
            requisitionData.requisitionNumber,
            new Date(requisitionData.requisitionDate).toISOString().slice(0, 19).replace('T', ' '),
            requisitionData.requestedByUserId || null,
            requisitionData.requestedByName,
            Number(requisitionData.siteId),
            statusToSave,
            requisitionData.approverId || null
        ]);
        for (const item of requisitionData.items){
            if (!item.description || !item.quantity) {
                await connection.rollback();
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: `Item description and quantity are required. Item problematic: ${JSON.stringify(item)}`
                }, {
                    status: 400
                });
            }
            // Item siteId removed from INSERT
            await connection.execute(`INSERT INTO RequisitionItem (id, requisitionId, partNumber, description, categoryId, quantity, notes, createdAt, updatedAt)
         VALUES (?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`, [
                item.id || (0, __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__["randomUUID"])(),
                generatedId,
                item.partNumber,
                item.description,
                item.categoryId ? Number(item.categoryId) : null,
                Number(item.quantity),
                item.justification
            ]);
        }
        await connection.commit();
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            message: 'Requisition created successfully',
            requisitionId: generatedId,
            requisitionNumber: requisitionData.requisitionNumber,
            status: statusToSave
        }, {
            status: 201
        });
    } catch (error) {
        if (connection) await connection.rollback();
        console.error('[API_ERROR] /api/requisitions POST:', error);
        let errorMessage = 'Failed to create requisition.';
        let statusCode = 500;
        let errorDetails = error.message || 'An unknown database error occurred.';
        if (error.code) {
            switch(error.code){
                case 'ER_DUP_ENTRY':
                    errorMessage = 'Requisition with this ID or Number already exists.';
                    statusCode = 409;
                    break;
                case 'ER_NO_REFERENCED_ROW_2':
                    let field = 'a related record';
                    const fkMatch = error.message.match(/FOREIGN KEY \(`(\w+)`\)/);
                    if (fkMatch && fkMatch[1]) {
                        field = `field '${fkMatch[1]}'`;
                    } else if (error.message.includes('fk_requisition_site')) field = 'Site ID for requisition header';
                    else if (error.message.includes('fk_requisition_user')) field = 'Requested By User ID';
                    else if (error.message.includes('fk_requisition_approver')) field = 'Approver ID';
                    else if (error.message.includes('fk_reqitem_category')) field = 'Item Category ID';
                    errorMessage = `Invalid reference for ${field}. Please ensure the selected value exists.`;
                    statusCode = 400;
                    break;
                case 'ER_BAD_NULL_ERROR':
                    errorMessage = `A required field was not provided or was invalid. Field: ${error.message.match(/Column '(\w+)'/)?.[1] || 'unknown'}`;
                    statusCode = 400;
                    break;
                case 'ER_BAD_FIELD_ERROR':
                    const columnMatch = error.message.match(/Unknown column '(\w+)'/);
                    const unknownColumn = columnMatch ? columnMatch[1].toLowerCase() : 'an unknown column';
                    errorMessage = `Database error: Unknown column '${unknownColumn}' in field list.`;
                    errorDetails = `The database table (possibly Requisition or RequisitionItem) is missing the column '${unknownColumn}' or it's misspelled in the query. Please ensure database migrations have been run correctly. Original DB error: ${error.message}`;
                    statusCode = 500;
                    break;
                default:
                    break;
            }
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: errorMessage,
            details: errorDetails,
            code: error.code || 'UNKNOWN_DB_ERROR'
        }, {
            status: statusCode
        });
    } finally{
        if (connection) connection.release();
    }
}
async function GET(request) {
    const { searchParams } = new URL(request.url);
    const month = searchParams.get('month');
    const year = searchParams.get('year');
    const siteId = searchParams.get('siteId'); // This will filter by Requisition.siteId (header site)
    const requestedByUserId = searchParams.get('requestedByUserId');
    const status = searchParams.get('status');
    let query = `
    SELECT 
      r.id, r.requisitionNumber, r.requisitionDate, r.requestedByName, r.status, 
      r.approverId, r.approvalDate,
      s.name as siteName, s.siteCode, -- This is for the header site
      u.name as requestorFullName,
      app.name as approverName
      -- Removed r.justification as it's no longer a header field from form
    FROM Requisition r
    LEFT JOIN Site s ON r.siteId = s.id -- Join for header site
    LEFT JOIN User u ON r.requestedByUserId = u.id
    LEFT JOIN Approver app ON r.approverId = app.id
    WHERE 1=1
  `;
    const queryParams = [];
    if (month && month !== 'all') {
        query += ' AND MONTH(r.requisitionDate) = ?';
        queryParams.push(parseInt(month, 10));
    }
    if (year && year !== 'all') {
        query += ' AND YEAR(r.requisitionDate) = ?';
        queryParams.push(parseInt(year, 10));
    }
    if (siteId && siteId !== 'all') {
        query += ' AND r.siteId = ?';
        queryParams.push(parseInt(siteId, 10));
    }
    if (requestedByUserId && requestedByUserId !== 'all') {
        query += ' AND r.requestedByUserId = ?';
        queryParams.push(requestedByUserId);
    }
    if (status && status !== 'all') {
        query += ' AND r.status = ?';
        queryParams.push(status);
    }
    query += ' ORDER BY r.requisitionDate DESC, r.requisitionNumber DESC';
    try {
        const [rows] = await __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["pool"].execute(query, queryParams);
        const requisitions = rows.map((row)=>({
                ...row,
                siteName: row.siteCode || row.siteName,
                requestedByName: row.requestorFullName || row.requestedByName,
                approverName: row.approverName,
                approvalDate: safeToISOString(row.approvalDate),
                requisitionDate: safeToISOString(row.requisitionDate)
            }));
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(requisitions);
    } catch (error) {
        console.error('[API_ERROR] /api/requisitions GET:', error);
        const errorMessage = error.sqlMessage || error.message || 'An unknown database error occurred.';
        const errorCode = error.code || 'UNKNOWN_DB_ERROR';
        const sqlState = error.sqlState || 'N/A';
        console.error(`[API_ERROR_DETAILS] /api/requisitions GET: Code: ${errorCode}, SQL State: ${sqlState}, Message: "${errorMessage}"`);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Failed to fetch requisitions due to a server-side database error.',
            details: `Database operation failed with message: "${errorMessage}". Error Code: ${errorCode}. SQL State: ${sqlState}. Please check server logs for the full query and parameters if the issue persists.`,
            code: errorCode,
            sqlState: sqlState
        }, {
            status: 500
        });
    }
}
}}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__ff804fc9._.js.map