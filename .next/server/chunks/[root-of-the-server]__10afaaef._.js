module.exports = {

"[project]/.next-internal/server/app/api/purchase-orders/route/actions.js [app-rsc] (server actions loader, ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({});
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/@opentelemetry/api [external] (@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@opentelemetry/api", () => require("@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/process [external] (process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[externals]/timers [external] (timers, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("timers", () => require("timers"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/string_decoder [external] (string_decoder, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("string_decoder", () => require("string_decoder"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/fs [external] (fs, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}}),
"[externals]/path [external] (path, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}}),
"[externals]/os [external] (os, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}}),
"[project]/backend/db.js [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "getDbPool": (()=>getDbPool)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/mysql2/promise.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/fs [external] (fs, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/path [external] (path, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$dotenv$2f$lib$2f$main$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/dotenv/lib/main.js [app-route] (ecmascript)");
;
;
;
;
// Configure dotenv to load the .env file from the backend directory at module load time.
__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$dotenv$2f$lib$2f$main$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].config({
    path: __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].resolve(process.cwd(), 'backend', '.env')
});
let pool = null;
async function getDbPool() {
    if (pool) {
        return pool;
    }
    // --- Debugging Environment ---
    console.log('[DB_INIT] Current working directory:', process.cwd());
    console.log('[DB_INIT] Checking for environment variables...');
    try {
        // Check for essential DB environment variables
        const essentialEnvVars = [
            'DB_HOST',
            'DB_USER',
            'DB_PASSWORD',
            'DB_NAME',
            'JWT_SECRET'
        ];
        const missingEnvVars = [];
        for (const v of essentialEnvVars){
            if (!process.env[v]) {
                missingEnvVars.push(v);
            } else {
                // Avoid logging password in production
                if (v !== 'DB_PASSWORD' && v !== 'JWT_SECRET') {
                    console.log(`[DB_INIT] Found ENV VAR: ${v} = ${process.env[v]}`);
                } else {
                    console.log(`[DB_INIT] Found ENV VAR: ${v} = (hidden)`);
                }
            }
        }
        if (missingEnvVars.length > 0) {
            const errorMsg = `Configuration is incomplete. Missing variables: ${missingEnvVars.join(', ')}. Please define these in your backend/.env file. For JWT_SECRET, use a long, random string.`;
            console.error(`[DB_INIT_ERROR] ${errorMsg}`);
            throw new Error(errorMsg);
        }
        // --- SSL Certificate Handling ---
        const caCertPathOrContent = process.env.DB_SSL_CA;
        let caCertContent;
        if (caCertPathOrContent) {
            const potentialPath = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].resolve(process.cwd(), caCertPathOrContent);
            if (__TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].existsSync(potentialPath) && __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].statSync(potentialPath).isFile()) {
                console.log(`DB_INIT_INFO: DB_SSL_CA points to a file. Reading certificate from "${potentialPath}".`);
                caCertContent = __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].readFileSync(potentialPath, 'utf8');
            } else {
                console.log("DB_INIT_INFO: DB_SSL_CA does not appear to be a file path. Using its content directly for SSL connection.");
                caCertContent = caCertPathOrContent;
            }
        } else {
            console.warn(`DB_WARN: The DB_SSL_CA environment variable is not set. Connecting with SSL using system default CAs. If connection fails, please provide the path to your 'ca.pem' file in the DB_SSL_CA variable in your .env file.`);
        }
        const sslConfig = {
            rejectUnauthorized: true,
            ca: caCertContent || undefined
        };
        // --- Connection Pool Creation ---
        console.log("DB_INIT_INFO: Creating database connection pool for the first time.");
        const newPool = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createPool({
            host: process.env.DB_HOST,
            user: process.env.DB_USER,
            password: process.env.DB_PASSWORD,
            database: process.env.DB_NAME,
            port: process.env.DB_PORT ? parseInt(process.env.DB_PORT, 10) : 3306,
            ssl: sslConfig,
            waitForConnections: true,
            connectionLimit: 10,
            queueLimit: 0
        });
        try {
            // Test the connection before assigning it to the singleton
            const connection = await newPool.getConnection();
            console.log("DB_INIT_SUCCESS: Database connection pool created and verified successfully.");
            connection.release();
        } catch (testError) {
            console.error("CRITICAL_DB_INIT_ERROR: Failed to get a connection from the pool after creation.", testError);
            // Destroy the pool if the initial connection test fails
            newPool.end();
            throw testError; // Re-throw to be caught by the main catch block
        }
        pool = newPool;
        return pool;
    } catch (error) {
        console.error(`CRITICAL_DB_INIT_ERROR: Failed to create and verify database connection pool. Error: ${error.message}`);
        // Re-throw the error to be caught by the calling API route
        throw error;
    }
}
;
}}),
"[project]/src/app/api/purchase-orders/route.js [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "GET": (()=>GET),
    "POST": (()=>POST)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$csv$2d$parser$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/csv-parser/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$stream__$5b$external$5d$__$28$stream$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/stream [external] (stream, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/backend/db.js [app-route] (ecmascript)");
;
;
;
;
// Helper to parse DD/MM/YYYY dates, common in CSVs
function parseDMY(dateString) {
    if (!dateString || typeof dateString !== 'string') return new Date();
    // Use regex to handle DD/MM/YYYY or DD-MM-YYYY
    const match = dateString.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
    if (match) {
        // match[1] is day, match[2] is month, match[3] is year
        const day = parseInt(match[1], 10);
        const month = parseInt(match[2], 10) - 1; // Month is 0-indexed in JS
        const year = parseInt(match[3], 10);
        // Create date in UTC to avoid timezone issues
        const date = new Date(Date.UTC(year, month, day));
        if (isNaN(date.getTime())) return new Date(); // Invalid date parsed
        return date;
    }
    // Fallback for ISO or other standard formats
    const parsedDate = new Date(dateString);
    if (!isNaN(parsedDate.getTime())) {
        return parsedDate;
    }
    return new Date(); // Final fallback
}
async function GET(request) {
    let connection;
    try {
        const pool = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getDbPool"])();
        connection = await pool.getConnection();
        const { searchParams } = new URL(request.url);
        const month = searchParams.get('month');
        const year = searchParams.get('year');
        const approverId = searchParams.get('approverId');
        const creatorUserId = searchParams.get('creatorUserId');
        const status = searchParams.get('status');
        // const overallSiteId = searchParams.get('siteId'); // Overall PO siteId filter removed
        let query = `
      SELECT
          po.id, po.poNumber, po.creationDate, po.status, po.subTotal, po.vatAmount,
          po.grandTotal, po.currency, po.pricesIncludeVat, po.notes, po.requestedByName, 
          po.creatorUserId, po.approverId, po.siteId AS overallSiteId, 
          s.supplierName, app.name AS approverName, u.name AS creatorName,
          overall_site.siteCode AS overallSiteName 
      FROM PurchaseOrder po
      LEFT JOIN Supplier s ON po.supplierId = s.supplierCode
      LEFT JOIN Approver app ON po.approverId = app.id
      LEFT JOIN User u ON po.creatorUserId = u.id
      LEFT JOIN Site overall_site ON po.siteId = overall_site.id 
      WHERE 1=1
    `;
        const queryParams = [];
        if (month && month !== 'all') {
            query += ' AND MONTH(po.creationDate) = ?';
            queryParams.push(parseInt(month, 10));
        }
        if (year && year !== 'all') {
            query += ' AND YEAR(po.creationDate) = ?';
            queryParams.push(parseInt(year, 10));
        }
        if (approverId && approverId !== 'all') {
            query += ' AND po.approverId = ?';
            queryParams.push(approverId);
        }
        if (creatorUserId && creatorUserId !== 'all') {
            query += ' AND po.creatorUserId = ?';
            queryParams.push(creatorUserId);
        }
        if (status && status !== 'all') {
            query += ' AND po.status = ?';
            queryParams.push(status);
        }
        // Overall PO siteId filter is removed as the field is removed from the form
        // if (overallSiteId && overallSiteId !== 'all') { 
        //   query += ' AND po.siteId = ?';
        //   queryParams.push(parseInt(overallSiteId, 10));
        // }
        query += ' ORDER BY po.creationDate DESC';
        const [rows] = await connection.execute(query, queryParams);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(rows);
    } catch (error) {
        console.error('[API_ERROR] /api/purchase-orders GET: Error fetching purchase orders:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Failed to fetch purchase orders',
            details: error.message
        }, {
            status: 500
        });
    } finally{
        if (connection) connection.release();
    }
}
async function POST(request) {
    const contentType = request.headers.get('content-type');
    let connection;
    try {
        const pool = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getDbPool"])();
        connection = await pool.getConnection();
        if (contentType && contentType.includes('application/json')) {
            console.log('[API_INFO] /api/purchase-orders POST: Received application/json request.');
            const poData = await request.json();
            const { poNumber, creationDate, creatorUserId, requestedByName, supplierId, approverId, /* siteId, */ status, subTotal, vatAmount, grandTotal, currency, pricesIncludeVat, notes, items, selectedRequisitionId } = poData;
            await connection.beginTransaction();
            const finalCreatorUserId = creatorUserId || null;
            // const finalSiteId = siteId ? Number(siteId) : null; // Removed finalSiteId, PO header siteId will be NULL
            const [poResult] = await connection.execute(`INSERT INTO PurchaseOrder (poNumber, creationDate, creatorUserId, requestedByName, supplierId, approverId, siteId, status, subTotal, vatAmount, grandTotal, currency, pricesIncludeVat, notes)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`, [
                poNumber,
                new Date(creationDate),
                finalCreatorUserId,
                requestedByName,
                supplierId,
                approverId,
                null,
                status,
                subTotal,
                vatAmount,
                grandTotal,
                currency,
                pricesIncludeVat,
                notes
            ] // siteId set to null
            );
            const newPoId = poResult.insertId;
            if (items && items.length > 0) {
                for (const item of items){
                    await connection.execute(`INSERT INTO POItem (poId, partNumber, description, categoryId, siteId, uom, quantity, unitPrice, quantityReceived, itemStatus)
             VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`, [
                        newPoId,
                        item.partNumber,
                        item.description,
                        item.categoryId,
                        item.siteId || null,
                        item.uom,
                        Number(item.quantity),
                        Number(item.unitPrice),
                        item.quantityReceived || 0,
                        item.itemStatus || 'Pending'
                    ]);
                }
            }
            if (selectedRequisitionId) {
                console.log(`[API_INFO] PO created from Requisition ID: ${selectedRequisitionId}. Attempting to update Requisition status.`);
                const [updateReqResult] = await connection.execute('UPDATE Requisition SET status = ? WHERE id = ? AND status = ?', [
                    'Closed',
                    selectedRequisitionId,
                    'Approved'
                ] // Mark as 'Closed', ensure it was 'Approved'
                );
                if (updateReqResult.affectedRows > 0) {
                    console.log(`[API_INFO] Requisition ID ${selectedRequisitionId} status updated to 'Closed'.`);
                } else {
                    console.warn(`[API_WARN] Failed to update Requisition ID ${selectedRequisitionId} status to 'Closed', or it was not in 'Approved' state.`);
                }
            }
            await connection.commit();
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Purchase order created successfully',
                poId: newPoId,
                poNumber: poNumber
            }, {
                status: 201
            });
        } else if (contentType && contentType.includes('multipart/form-data')) {
            // REFACTORED CSV UPLOAD LOGIC
            console.log('[API_INFO] /api/purchase-orders POST: Received multipart/form-data request for CSV upload.');
            const formData = await request.formData();
            const file = formData.get('file');
            if (!file || typeof file === 'string') {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'No file uploaded or invalid file type'
                }, {
                    status: 400
                });
            }
            const fileBuffer = Buffer.from(await file.arrayBuffer());
            const results = [];
            const stream = __TURBOPACK__imported__module__$5b$externals$5d2f$stream__$5b$external$5d$__$28$stream$2c$__cjs$29$__["Readable"].from(fileBuffer);
            await new Promise((resolve, reject)=>{
                stream.pipe((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$csv$2d$parser$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
                    mapHeaders: ({ header })=>header.trim().toLowerCase().replace(/\s+/g, '') // Make headers consistent
                })).on('data', (data)=>results.push(data)).on('end', resolve).on('error', reject);
            });
            if (results.length === 0) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    message: 'Purchase Order CSV file is empty or could not be parsed.'
                }, {
                    status: 400
                });
            }
            const posGroupedByNumber = results.reduce((acc, row)=>{
                const poNumber = row.ponumber?.trim();
                if (!poNumber) return acc;
                if (!acc[poNumber]) acc[poNumber] = [];
                acc[poNumber].push(row);
                return acc;
            }, {});
            const [suppliers] = await connection.execute('SELECT supplierCode FROM Supplier');
            const [approvers] = await connection.execute('SELECT id FROM Approver');
            const [categories] = await connection.execute('SELECT id FROM Category');
            const [sites] = await connection.execute('SELECT id FROM Site');
            const supplierSet = new Set(suppliers.map((s)=>s.supplierCode));
            const approverSet = new Set(approvers.map((a)=>a.id));
            const categorySet = new Set(categories.map((c)=>c.id));
            const siteSet = new Set(sites.map((s)=>s.id));
            let successfulImports = 0;
            let failedImports = 0;
            const errors = [];
            await connection.beginTransaction();
            for(const poNumber in posGroupedByNumber){
                const poItems = posGroupedByNumber[poNumber];
                const headerRow = poItems[0];
                try {
                    // --- Standardized Header Mapping ---
                    const supplierId = headerRow.supplierid?.trim();
                    const approverId = headerRow.approverid?.trim();
                    const creationDate = headerRow.podate?.trim();
                    const notes = headerRow.notes?.trim();
                    const status = headerRow.status?.trim() || 'Approved';
                    const pricesIncludeVatValue = String(headerRow.pricesincludevat || 'false').toLowerCase().trim();
                    // --- Validation ---
                    if (!supplierId || !supplierSet.has(supplierId)) {
                        throw new Error(`SupplierID '${supplierId || 'empty'}' does not exist.`);
                    }
                    if (!approverId || !approverSet.has(approverId)) {
                        throw new Error(`ApproverID '${approverId || 'empty'}' does not exist.`);
                    }
                    let subTotal = 0;
                    for (const [index, item] of poItems.entries()){
                        const qty = parseFloat(item.itemquantity?.trim());
                        const price = parseFloat(item.itemunitprice?.trim());
                        if (isNaN(qty) || isNaN(price)) {
                            throw new Error(`Invalid quantity or unit price for an item at row ${index + 2} in PO ${poNumber}.`);
                        }
                        subTotal += qty * price;
                    }
                    const pricesIncludeVat = [
                        'true',
                        '1',
                        'yes'
                    ].includes(pricesIncludeVatValue);
                    let vatAmount = 0;
                    // --- FIXED VAT CALCULATION ---
                    if (headerRow.currency?.trim() === 'MZN' && !pricesIncludeVat) {
                        vatAmount = subTotal * 0.16;
                    }
                    const grandTotal = subTotal + vatAmount;
                    const poInsertQuery = `
            INSERT INTO PurchaseOrder (poNumber, creationDate, creatorUserId, requestedByName, supplierId, approverId, siteId, status, subTotal, vatAmount, grandTotal, currency, pricesIncludeVat, notes)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `;
                    const [poResult] = await connection.execute(poInsertQuery, [
                        poNumber,
                        creationDate ? parseDMY(creationDate) : new Date(),
                        headerRow.creatorid?.trim() || null,
                        headerRow.requestedbyname?.trim() || null,
                        supplierId,
                        approverId,
                        null,
                        status,
                        subTotal,
                        vatAmount,
                        grandTotal,
                        headerRow.currency?.trim() || 'MZN',
                        pricesIncludeVat,
                        notes || null
                    ]);
                    const newPoId = poResult.insertId;
                    for (const item of poItems){
                        const categoryId = item.itemcategoryid ? parseInt(item.itemcategoryid.trim(), 10) : null;
                        const itemSiteId = item.itemsiteid ? parseInt(item.itemsiteid.trim(), 10) : null;
                        if (categoryId && !categorySet.has(categoryId)) {
                            throw new Error(`Item in PO ${poNumber} has an invalid CategoryID: ${categoryId}`);
                        }
                        if (itemSiteId && !siteSet.has(itemSiteId)) {
                            throw new Error(`Item in PO ${poNumber} has an invalid ItemSiteID: ${itemSiteId}`);
                        }
                        // CORRECTED: Explicitly include all non-null columns with defaults
                        const itemInsertQuery = `
              INSERT INTO POItem (poId, partNumber, description, categoryId, siteId, uom, quantity, unitPrice, quantityReceived, itemStatus)
              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            `;
                        await connection.execute(itemInsertQuery, [
                            newPoId,
                            item.itempartnumber?.trim() || null,
                            item.itemdescription?.trim() || 'N/A',
                            categoryId,
                            itemSiteId,
                            item.itemuom?.trim() || 'EA',
                            parseFloat(item.itemquantity?.trim()) || 0,
                            parseFloat(item.itemunitprice?.trim()) || 0,
                            0,
                            'Pending' // Explicitly set itemStatus to 'Pending'
                        ]);
                    }
                    successfulImports++;
                } catch (error) {
                    failedImports++;
                    const errorMessage = `Failed to import PO ${poNumber}: ${error.message}. Check if all IDs (Supplier, Approver, Category, Site) exist and dates are DD/MM/YYYY.`;
                    errors.push(errorMessage);
                }
            }
            if (failedImports > 0) {
                await connection.rollback();
                console.warn(`[API_WARN] PO CSV Upload: Rolled back transaction due to ${failedImports} POs failing.`, errors);
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    message: `Upload failed. ${failedImports} out of ${Object.keys(posGroupedByNumber).length} POs had errors, so the entire upload was cancelled. Please check the errors below, fix the CSV, and re-upload.`,
                    errors: errors
                }, {
                    status: 400
                });
            } else {
                await connection.commit();
                console.log(`[API_INFO] PO CSV Upload: Transaction committed successfully for ${successfulImports} POs.`);
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    message: `Successfully imported ${successfulImports} Purchase Orders and their items into the database.`
                }, {
                    status: 200
                });
            }
        } else {
            console.warn(`[API_WARN] /api/purchase-orders POST: Unsupported Content-Type: ${contentType}`);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unsupported Content-Type'
            }, {
                status: 415
            });
        }
    } catch (dbError) {
        if (connection) {
            await connection.rollback();
        }
        console.error('[API_ERROR] /api/purchase-orders POST: Error creating purchase order:', dbError);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Failed to create purchase order due to a server error.',
            details: dbError.message
        }, {
            status: 500
        });
    } finally{
        if (connection) {
            connection.release();
        }
    }
}
}}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__10afaaef._.js.map