module.exports = {

"[project]/.next-internal/server/app/api/quotes/route/actions.js [app-rsc] (server actions loader, ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({});
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/@opentelemetry/api [external] (@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@opentelemetry/api", () => require("@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/process [external] (process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[externals]/timers [external] (timers, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("timers", () => require("timers"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/string_decoder [external] (string_decoder, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("string_decoder", () => require("string_decoder"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/fs [external] (fs, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}}),
"[externals]/path [external] (path, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}}),
"[externals]/os [external] (os, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}}),
"[project]/backend/db.js [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "pool": (()=>pool)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/mysql2/promise.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$dotenv$2f$lib$2f$main$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/dotenv/lib/main.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/path [external] (path, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/fs [external] (fs, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$url__$5b$external$5d$__$28$url$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/url [external] (url, cjs)");
const __TURBOPACK__import$2e$meta__ = {
    get url () {
        return `file://${__turbopack_context__.P("backend/db.js")}`;
    }
};
;
;
;
;
;
// Get the directory name in ES module scope
const __filename = (0, __TURBOPACK__imported__module__$5b$externals$5d2f$url__$5b$external$5d$__$28$url$2c$__cjs$29$__["fileURLToPath"])(__TURBOPACK__import$2e$meta__.url);
const __dirname = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].dirname(__filename);
// Construct absolute path to .env file in the parent directory
const envPath = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].resolve(__dirname, ".env");
__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$dotenv$2f$lib$2f$main$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].config({
    path: envPath
});
// Construct absolute path to ca.pem file in the same directory
const caPath = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].resolve(__dirname, "ca.pem");
let caCert;
try {
    if (!__TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].existsSync(caPath)) {
        console.error(`CRITICAL_DB_INIT_ERROR: CA certificate file (ca.pem) not found at expected location: ${caPath}. Database connections requiring SSL will likely fail. Please ensure 'backend/ca.pem' exists.`);
    // caCert will remain undefined. mysql.createPool might fail if SSL is strictly required.
    } else {
        caCert = __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].readFileSync(caPath, 'utf8');
    }
} catch (e) {
    console.error(`CRITICAL_DB_INIT_ERROR: Error reading CA certificate file (ca.pem) at ${caPath}: ${e.message}. Database connections may fail.`);
// Depending on the error, caCert might be undefined or an error could be thrown, halting further execution.
// For robustness, we could choose to throw here to make the failure explicit.
// throw new Error(`Failed to read ca.pem: ${e.message}`);
}
// Check for essential DB environment variables
const essentialEnvVars = [
    'DB_HOST',
    'DB_USER',
    'DB_PASSWORD',
    'DB_NAME'
];
const missingEnvVars = essentialEnvVars.filter((v)=>!process.env[v]);
if (missingEnvVars.length > 0) {
    console.error(`CRITICAL_DB_INIT_ERROR: Missing essential database environment variables: ${missingEnvVars.join(', ')}. These should be defined in backend/.env for local development or configured in your hosting environment. Database connections will fail.`);
// To make the server fail fast and clearly, throwing an error here is a good practice.
// This prevents a more obscure "Internal Server Error" later.
// throw new Error(`Missing critical DB environment variables: ${missingEnvVars.join(', ')}. Check your backend/.env file or hosting configuration.`);
}
let pool;
try {
    pool = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createPool({
        host: process.env.DB_HOST,
        user: process.env.DB_USER,
        password: process.env.DB_PASSWORD,
        database: process.env.DB_NAME,
        port: process.env.DB_PORT ? parseInt(process.env.DB_PORT, 10) : 3306,
        ssl: {
            ca: caCert,
            rejectUnauthorized: true
        },
        waitForConnections: true,
        connectionLimit: 10,
        queueLimit: 0
    });
    console.log("DB_INIT_SUCCESS: MySQL connection pool created (this does not guarantee successful connection yet, but configuration is loaded).");
} catch (error) {
    console.error(`CRITICAL_DB_INIT_ERROR: Failed to create MySQL connection pool: ${error.message}. This is a fatal error for database operations.`);
    // Re-throwing the error here will make the application fail on startup if the pool cannot be initialized,
    // which is often better than encountering errors later during request handling.
    throw new Error(`Failed to initialize database connection pool due to: ${error.message}. Review DB configuration (backend/.env) and SSL certificate (backend/ca.pem).`);
}
;
}}),
"[project]/src/app/api/quotes/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "GET": (()=>GET),
    "POST": (()=>POST)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/backend/db.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$csv$2d$parser$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/csv-parser/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$stream__$5b$external$5d$__$28$stream$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/stream [external] (stream, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/crypto [external] (crypto, cjs)");
;
;
;
;
;
async function POST(request) {
    const contentType = request.headers.get('content-type');
    let connection;
    console.log(`[API_INFO] /api/quotes POST: Received request with Content-Type: ${contentType}`);
    if (contentType && contentType.includes('multipart/form-data')) {
        console.log('[API_INFO] /api/quotes POST: Processing multipart/form-data for CSV upload.');
        try {
            const formData = await request.formData();
            const file = formData.get('file');
            if (!file) {
                console.error('[API_ERROR] /api/quotes POST CSV: No file found in formData.');
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'No file uploaded for quotes'
                }, {
                    status: 400
                });
            }
            console.log(`[API_INFO] /api/quotes POST CSV: Received file: ${file.name}, size: ${file.size}, type: ${file.type}`);
            const fileBuffer = Buffer.from(await file.arrayBuffer());
            const results = [];
            const stream = __TURBOPACK__imported__module__$5b$externals$5d2f$stream__$5b$external$5d$__$28$stream$2c$__cjs$29$__["Readable"].from(fileBuffer);
            let firstRecordLogged = false;
            console.log('[API_INFO] /api/quotes POST CSV: Starting CSV parsing...');
            await new Promise((resolve, reject)=>{
                stream.pipe((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$csv$2d$parser$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
                    mapHeaders: ({ header })=>header.trim()
                })).on('headers', (headers)=>console.log('[API_INFO] /api/quotes POST CSV: Detected CSV Headers:', headers)).on('data', (data)=>{
                    if (!firstRecordLogged) {
                        console.log('[API_DEBUG] /api/quotes POST CSV: First parsed data record from CSV:', data);
                        firstRecordLogged = true;
                    }
                    results.push(data);
                }).on('end', ()=>{
                    console.log(`[API_INFO] /api/quotes POST CSV: CSV parsing finished. ${results.length} records found.`);
                    resolve();
                }).on('error', (parseError)=>{
                    console.error('[API_ERROR] /api/quotes POST CSV: Error during CSV parsing:', parseError);
                    reject(parseError);
                });
            });
            if (results.length === 0) {
                console.warn('[API_WARN] /api/quotes POST CSV: CSV file is empty or yielded no records.');
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    message: 'CSV file is empty or yielded no records for quotes.'
                }, {
                    status: 400
                });
            }
            console.log('[API_INFO] /api/quotes POST CSV: Attempting to get database connection for batch insert/update.');
            connection = await __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["pool"].getConnection();
            console.log('[API_INFO] /api/quotes POST CSV: Database connection obtained.');
            await connection.beginTransaction();
            console.log('[API_INFO] /api/quotes POST CSV: Database transaction started.');
            let successfulImports = 0;
            const importErrors = [];
            for (const [index, record] of results.entries()){
                const quoteId = record['ID'] || record['id'] || (0, __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__["randomUUID"])();
                const quoteData = {
                    id: quoteId,
                    quoteNumber: record['QuoteNumber'] || `CSV-Q-${quoteId.slice(0, 8)}`,
                    quoteDate: record['QuoteDate'] ? new Date(record['QuoteDate']).toISOString() : new Date().toISOString(),
                    clientId: record['ClientID'] || record['ClientId'] || record['clientId'],
                    creatorEmail: record['CreatorEmail'] || 'csv_import@system.com',
                    subTotal: parseFloat(record['SubTotal'] || 0),
                    vatAmount: parseFloat(record['VATAmount'] || 0),
                    grandTotal: parseFloat(record['GrandTotal'] || 0),
                    currency: record['Currency'] || 'MZN',
                    termsAndConditions: record['TermsAndConditions'],
                    notes: record['Notes'],
                    status: record['Status'] || 'Draft',
                    approverId: record['ApproverID'] || record['ApproverId'] || record['approverId'] || null,
                    approvalDate: record['ApprovalDate'] ? new Date(record['ApprovalDate']).toISOString() : null
                };
                console.log(`[API_DEBUG] /api/quotes POST CSV: Processing record #${index + 1}: ${JSON.stringify(quoteData).substring(0, 300)}...`);
                if (!quoteData.clientId) {
                    const errorMsg = `Skipped record #${index + 1} (QuoteNumber: ${quoteData.quoteNumber}): ClientID is missing.`;
                    console.warn(`[API_WARN] /api/quotes POST CSV: ${errorMsg}`);
                    importErrors.push(errorMsg);
                    continue;
                }
                try {
                    const rawApproverId = quoteData.approverId;
                    const finalApproverId = rawApproverId === "" || rawApproverId === undefined ? null : rawApproverId;
                    await connection.execute(`INSERT INTO Quote (id, quoteNumber, quoteDate, clientId, creatorEmail, subTotal, vatAmount, grandTotal, currency, termsAndConditions, notes, status, approverId, approvalDate, createdAt, updatedAt)
             VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`, [
                        quoteData.id,
                        quoteData.quoteNumber,
                        new Date(quoteData.quoteDate).toISOString().slice(0, 19).replace('T', ' '),
                        quoteData.clientId,
                        quoteData.creatorEmail,
                        quoteData.subTotal,
                        quoteData.vatAmount,
                        quoteData.grandTotal,
                        quoteData.currency,
                        quoteData.termsAndConditions,
                        quoteData.notes,
                        quoteData.status,
                        finalApproverId,
                        quoteData.approvalDate ? new Date(quoteData.approvalDate).toISOString().slice(0, 19).replace('T', ' ') : null
                    ]);
                    successfulImports++;
                    console.log(`[API_INFO] /api/quotes POST CSV: Successfully processed quote ID: ${quoteData.id}`);
                } catch (dbError) {
                    const errorMsg = `Error importing record #${index + 1} (QuoteNumber ${quoteData.quoteNumber}): ${dbError.message}. SQL Error Code: ${dbError.code || 'N/A'}.`;
                    console.error(`[API_ERROR] /api/quotes POST CSV: Database error for record: ${errorMsg}`, dbError);
                    importErrors.push(errorMsg);
                }
            }
            await connection.commit();
            console.log('[API_INFO] /api/quotes POST CSV: Database transaction committed.');
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: `${successfulImports} quote header(s) processed from CSV. ${importErrors.length > 0 ? `${importErrors.length} error(s).` : ''}`,
                errors: importErrors.length > 0 ? importErrors : undefined
            }, {
                status: importErrors.length > 0 && successfulImports === 0 ? 400 : 200
            });
        } catch (error) {
            if (connection) {
                try {
                    await connection.rollback();
                    console.log('[API_INFO] /api/quotes POST CSV: Database transaction rolled back due to error.');
                } catch (rbError) {
                    console.error('[API_ERROR] /api/quotes POST CSV: Error during transaction rollback:', rbError);
                }
            }
            console.error('[API_ERROR] /api/quotes POST CSV (outer try-catch):', error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to handle quote CSV upload.',
                details: error.message
            }, {
                status: 500
            });
        } finally{
            if (connection) {
                try {
                    connection.release();
                    console.log('[API_INFO] /api/quotes POST CSV: Database connection released.');
                } catch (relError) {
                    console.error('[API_ERROR] /api/quotes POST CSV: Error releasing connection:', relError);
                }
            }
        }
    } else if (contentType && contentType.includes('application/json')) {
        console.log('[API_INFO] /api/quotes POST JSON: Processing application/json request.');
        let quoteDataFromForm = null;
        try {
            quoteDataFromForm = await request.json();
            console.log(`[API_INFO] /api/quotes POST JSON: Received quote data: ${JSON.stringify(quoteDataFromForm).substring(0, 500)}...`);
            console.log(`[API_INFO] /api/quotes POST JSON: Received approverId: '${quoteDataFromForm.approverId}', Type: ${typeof quoteDataFromForm.approverId}`);
            if (!quoteDataFromForm.id || !quoteDataFromForm.clientId || !quoteDataFromForm.quoteNumber) {
                console.error('[API_ERROR] /api/quotes POST JSON: Missing required fields (id, clientId, quoteNumber). Data:', quoteDataFromForm);
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'Quote ID, Client ID, and Quote Number are required.'
                }, {
                    status: 400
                });
            }
            console.log('[API_INFO] /api/quotes POST JSON: Attempting to get database connection.');
            connection = await __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["pool"].getConnection();
            console.log('[API_INFO] /api/quotes POST JSON: Database connection obtained.');
            await connection.beginTransaction();
            console.log('[API_INFO] /api/quotes POST JSON: Database transaction started.');
            const rawApproverId = quoteDataFromForm.approverId;
            const finalApproverId = rawApproverId === "" || rawApproverId === undefined ? null : rawApproverId;
            console.log(`[API_INFO] /api/quotes POST JSON: Final approverId for DB: '${finalApproverId}', Type: ${typeof finalApproverId}`);
            await connection.execute(`INSERT INTO Quote (id, quoteNumber, quoteDate, clientId, creatorEmail, subTotal, vatAmount, grandTotal, currency, termsAndConditions, notes, status, approverId, approvalDate, createdAt, updatedAt)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`, [
                quoteDataFromForm.id,
                quoteDataFromForm.quoteNumber,
                new Date(quoteDataFromForm.quoteDate).toISOString().slice(0, 19).replace('T', ' '),
                quoteDataFromForm.clientId,
                quoteDataFromForm.creatorEmail,
                quoteDataFromForm.subTotal,
                quoteDataFromForm.vatAmount,
                quoteDataFromForm.grandTotal,
                quoteDataFromForm.currency,
                quoteDataFromForm.termsAndConditions,
                quoteDataFromForm.notes,
                quoteDataFromForm.status,
                finalApproverId,
                quoteDataFromForm.approvalDate ? new Date(quoteDataFromForm.approvalDate).toISOString().slice(0, 19).replace('T', ' ') : null
            ]);
            console.log(`[API_INFO] /api/quotes POST JSON: Quote header inserted for ID: ${quoteDataFromForm.id}.`);
            if (quoteDataFromForm.items && quoteDataFromForm.items.length > 0) {
                console.log(`[API_INFO] /api/quotes POST JSON: Processing ${quoteDataFromForm.items.length} items for quote ID: ${quoteDataFromForm.id}.`);
                for (const item of quoteDataFromForm.items){
                    await connection.execute(`INSERT INTO QuoteItem (id, quoteId, partNumber, customerRef, description, quantity, unitPrice)
             VALUES (?, ?, ?, ?, ?, ?, ?)`, [
                        item.id || (0, __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__["randomUUID"])(),
                        quoteDataFromForm.id,
                        item.partNumber,
                        item.customerRef,
                        item.description,
                        item.quantity,
                        item.unitPrice
                    ]);
                }
                console.log(`[API_INFO] /api/quotes POST JSON: Finished processing items for quote ID: ${quoteDataFromForm.id}.`);
            } else {
                console.log(`[API_INFO] /api/quotes POST JSON: No items to process for quote ID: ${quoteDataFromForm.id}.`);
            }
            await connection.commit();
            console.log(`[API_INFO] /api/quotes POST JSON: Database transaction committed for quote ID: ${quoteDataFromForm.id}.`);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Quote saved successfully',
                quoteId: quoteDataFromForm.id,
                quoteNumber: quoteDataFromForm.quoteNumber
            }, {
                status: 201
            });
        } catch (error) {
            if (connection) {
                try {
                    await connection.rollback();
                    console.log('[API_INFO] /api/quotes POST JSON: Database transaction rolled back due to error.');
                } catch (rbError) {
                    console.error('[API_ERROR] /api/quotes POST JSON: Error during transaction rollback:', rbError);
                }
            }
            const quoteIdentifier = quoteDataFromForm ? `ID ${quoteDataFromForm.id} or Number ${quoteDataFromForm.quoteNumber}` : 'given details';
            console.error(`[API_ERROR] /api/quotes POST JSON (outer try-catch) for ${quoteIdentifier}:`, error);
            let errorMessage = `Failed to create quote.`;
            let errorDetails = error.message;
            if (error.code === 'ER_DUP_ENTRY') {
                errorMessage = `Quote with ${quoteIdentifier} already exists.`;
            } else if (error.code === 'ER_NO_REFERENCED_ROW_2') {
                errorMessage = `Failed to create quote. Invalid reference to Client or Approver.`;
                errorDetails = `Client ID '${quoteDataFromForm?.clientId}' or Approver ID '${quoteDataFromForm?.approverId}' might not exist. Specific error: ${error.message}`;
            } else if (error.code === 'ER_BAD_NULL_ERROR' && error.message.includes('approverId')) {
                errorMessage = `Failed to create quote. Approver ID cannot be null if trying to set it as foreign key and it's not allowed.`;
            }
            console.error(`[API_ERROR_DETAILS] /api/quotes POST JSON: Code: ${error.code}, Message: ${error.message}, Stack: ${error.stack}`);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: errorMessage,
                details: errorDetails,
                code: error.code
            }, {
                status: 500
            });
        } finally{
            if (connection) {
                try {
                    connection.release();
                    console.log('[API_INFO] /api/quotes POST JSON: Database connection released.');
                } catch (relError) {
                    console.error('[API_ERROR] /api/quotes POST JSON: Error releasing connection:', relError);
                }
            }
        }
    } else {
        console.warn(`[API_WARN] /api/quotes POST: Unsupported Content-Type: ${contentType}`);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Unsupported Content-Type for Quotes POST'
        }, {
            status: 415
        });
    }
}
async function GET(request) {
    console.log('[API_INFO] /api/quotes GET: Request received.');
    let connection;
    try {
        const { searchParams } = new URL(request.url);
        console.log('[API_INFO] /api/quotes GET: URL parsed successfully.');
        const month = searchParams.get('month');
        const year = searchParams.get('year');
        let query = `
      SELECT 
        q.id, q.quoteNumber, q.quoteDate, q.clientId, q.creatorEmail, 
        q.subTotal, q.vatAmount, q.grandTotal, q.currency, 
        q.termsAndConditions, q.notes, q.status, q.approverId, q.approvalDate,
        c.name as clientName, c.email as clientEmail,
        app.name as approverName
      FROM Quote q
      LEFT JOIN Client c ON q.clientId = c.id
      LEFT JOIN Approver app ON q.approverId = app.id
      WHERE 1=1
    `;
        const queryParams = [];
        if (month && month !== 'all') {
            query += ' AND MONTH(q.quoteDate) = ?';
            queryParams.push(parseInt(month, 10));
        }
        if (year && year !== 'all') {
            query += ' AND YEAR(q.quoteDate) = ?';
            queryParams.push(parseInt(year, 10));
        }
        query += ' ORDER BY q.quoteDate DESC, q.quoteNumber DESC';
        console.log(`[API_INFO] /api/quotes GET: Query constructed. Params: ${JSON.stringify(queryParams)}. Query: ${query.substring(0, 300)}...`);
        console.log('[API_INFO] /api/quotes GET: Attempting to get database connection...');
        connection = await __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["pool"].getConnection();
        console.log('[API_INFO] /api/quotes GET: Database connection obtained.');
        console.log('[API_INFO] /api/quotes GET: Attempting to execute query...');
        const [rows] = await connection.execute(query, queryParams);
        console.log(`[API_INFO] /api/quotes GET: Query executed. Rows fetched: ${Array.isArray(rows) ? rows.length : 'N/A'}.`);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(rows);
    } catch (error) {
        let errorMessage = 'Failed to fetch quotes due to an unknown server error.';
        let errorDetails = '';
        let errorCode = 'UNKNOWN_ERROR';
        let errorStack = '';
        if (error instanceof Error) {
            errorMessage = `Failed to fetch quotes: ${error.name}`;
            errorDetails = error.message;
            errorStack = error.stack || 'No stack available.';
            if (error.code) {
                errorCode = error.code;
            }
        } else if (typeof error === 'string') {
            errorMessage = `Failed to fetch quotes: ${error}`;
            errorDetails = error;
        } else if (error && typeof error === 'object' && 'message' in error && typeof error.message === 'string') {
            errorMessage = `Failed to fetch quotes: Error`;
            errorDetails = error.message;
            if ('code' in error && typeof error.code === 'string') errorCode = error.code;
            if ('stack' in error && typeof error.stack === 'string') errorStack = error.stack;
        }
        console.error(`[API_ERROR] /api/quotes GET: ${errorMessage}. Details: ${errorDetails}. Code: ${errorCode}.`);
        console.error(`[API_ERROR_STACK] /api/quotes GET: ${errorStack}`);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: errorMessage,
            details: errorDetails,
            code: errorCode
        }, {
            status: 500
        });
    } finally{
        if (connection) {
            try {
                console.log('[API_INFO] /api/quotes GET: Attempting to release database connection in finally block.');
                connection.release();
                console.log('[API_INFO] /api/quotes GET: Database connection released.');
            } catch (releaseError) {
                console.error(`[API_ERROR] /api/quotes GET: Error releasing database connection in finally block: ${releaseError.message}`);
            }
        }
        console.log('[API_INFO] /api/quotes GET: Request processing finished.');
    }
}
}}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__190d7c77._.js.map