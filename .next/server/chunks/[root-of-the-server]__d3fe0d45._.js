module.exports = {

"[project]/.next-internal/server/app/api/purchase-orders/route/actions.js [app-rsc] (server actions loader, ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({});
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/@opentelemetry/api [external] (@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@opentelemetry/api", () => require("@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/process [external] (process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[externals]/timers [external] (timers, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("timers", () => require("timers"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/string_decoder [external] (string_decoder, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("string_decoder", () => require("string_decoder"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/fs [external] (fs, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}}),
"[externals]/path [external] (path, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}}),
"[externals]/os [external] (os, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}}),
"[project]/backend/db.js [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "pool": (()=>pool)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/mysql2/promise.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$dotenv$2f$lib$2f$main$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/dotenv/lib/main.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/path [external] (path, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/fs [external] (fs, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$url__$5b$external$5d$__$28$url$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/url [external] (url, cjs)");
const __TURBOPACK__import$2e$meta__ = {
    get url () {
        return `file://${__turbopack_context__.P("backend/db.js")}`;
    }
};
;
;
;
;
;
// Get the directory name in ES module scope
const __filename = (0, __TURBOPACK__imported__module__$5b$externals$5d2f$url__$5b$external$5d$__$28$url$2c$__cjs$29$__["fileURLToPath"])(__TURBOPACK__import$2e$meta__.url);
const __dirname = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].dirname(__filename);
// Construct absolute path to .env file in the parent directory
const envPath = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].resolve(__dirname, ".env");
__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$dotenv$2f$lib$2f$main$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].config({
    path: envPath
});
// Construct absolute path to ca.pem file in the same directory
const caPath = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].resolve(__dirname, "ca.pem");
let caCert;
try {
    if (!__TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].existsSync(caPath)) {
        console.error(`CRITICAL_DB_INIT_ERROR: CA certificate file (ca.pem) not found at expected location: ${caPath}. Database connections requiring SSL will likely fail. Please ensure 'backend/ca.pem' exists.`);
    // caCert will remain undefined. mysql.createPool might fail if SSL is strictly required.
    } else {
        caCert = __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].readFileSync(caPath, 'utf8');
    }
} catch (e) {
    console.error(`CRITICAL_DB_INIT_ERROR: Error reading CA certificate file (ca.pem) at ${caPath}: ${e.message}. Database connections may fail.`);
// Depending on the error, caCert might be undefined or an error could be thrown, halting further execution.
// For robustness, we could choose to throw here to make the failure explicit.
// throw new Error(`Failed to read ca.pem: ${e.message}`);
}
// Check for essential DB environment variables
const essentialEnvVars = [
    'DB_HOST',
    'DB_USER',
    'DB_PASSWORD',
    'DB_NAME'
];
const missingEnvVars = essentialEnvVars.filter((v)=>!process.env[v]);
if (missingEnvVars.length > 0) {
    console.error(`CRITICAL_DB_INIT_ERROR: Missing essential database environment variables: ${missingEnvVars.join(', ')}. These should be defined in backend/.env for local development or configured in your hosting environment. Database connections will fail.`);
    // To make the server fail fast and clearly, throwing an error here is a good practice.
    // This prevents a more obscure "Internal Server Error" later.
    throw new Error(`Missing critical DB environment variables: ${missingEnvVars.join(', ')}. Check your backend/.env file or hosting configuration.`);
}
let pool;
try {
    pool = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createPool({
        host: process.env.DB_HOST,
        user: process.env.DB_USER,
        password: process.env.DB_PASSWORD,
        database: process.env.DB_NAME,
        port: process.env.DB_PORT ? parseInt(process.env.DB_PORT, 10) : 3306,
        ssl: {
            ca: caCert,
            rejectUnauthorized: true
        },
        waitForConnections: true,
        connectionLimit: 10,
        queueLimit: 0
    });
    console.log("DB_INIT_SUCCESS: MySQL connection pool created (this does not guarantee successful connection yet, but configuration is loaded).");
} catch (error) {
    console.error(`CRITICAL_DB_INIT_ERROR: Failed to create MySQL connection pool: ${error.message}. This is a fatal error for database operations.`);
    // Re-throwing the error here will make the application fail on startup if the pool cannot be initialized,
    // which is often better than encountering errors later during request handling.
    throw new Error(`Failed to initialize database connection pool due to: ${error.message}. Review DB configuration (backend/.env) and SSL certificate (backend/ca.pem).`);
}
;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[project]/src/app/api/purchase-orders/route.js [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "GET": (()=>GET),
    "POST": (()=>POST)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/backend/db.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$csv$2d$parser$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/csv-parser/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$stream__$5b$external$5d$__$28$stream$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/stream [external] (stream, cjs)");
;
;
;
;
async function GET(request) {
    const { searchParams } = new URL(request.url);
    const month = searchParams.get('month');
    const year = searchParams.get('year');
    const approverId = searchParams.get('approverId');
    const creatorUserId = searchParams.get('creatorUserId');
    const status = searchParams.get('status');
    // const overallSiteId = searchParams.get('siteId'); // Overall PO siteId filter removed
    let query = `
    SELECT
        po.id, po.poNumber, po.creationDate, po.status, po.subTotal, po.vatAmount,
        po.grandTotal, po.currency, po.pricesIncludeVat, po.notes, po.requestedByName, 
        po.creatorUserId, po.approverId, po.siteId AS overallSiteId, 
        s.supplierName, app.name AS approverName, u.name AS creatorName,
        overall_site.siteCode AS overallSiteName 
    FROM PurchaseOrder po
    LEFT JOIN Supplier s ON po.supplierId = s.supplierCode
    LEFT JOIN Approver app ON po.approverId = app.id
    LEFT JOIN User u ON po.creatorUserId = u.id
    LEFT JOIN Site overall_site ON po.siteId = overall_site.id 
    WHERE 1=1
  `;
    const queryParams = [];
    if (month && month !== 'all') {
        query += ' AND MONTH(po.creationDate) = ?';
        queryParams.push(parseInt(month, 10));
    }
    if (year && year !== 'all') {
        query += ' AND YEAR(po.creationDate) = ?';
        queryParams.push(parseInt(year, 10));
    }
    if (approverId && approverId !== 'all') {
        query += ' AND po.approverId = ?';
        queryParams.push(approverId);
    }
    if (creatorUserId && creatorUserId !== 'all') {
        query += ' AND po.creatorUserId = ?';
        queryParams.push(creatorUserId);
    }
    if (status && status !== 'all') {
        query += ' AND po.status = ?';
        queryParams.push(status);
    }
    // Overall PO siteId filter is removed as the field is removed from the form
    // if (overallSiteId && overallSiteId !== 'all') { 
    //   query += ' AND po.siteId = ?';
    //   queryParams.push(parseInt(overallSiteId, 10));
    // }
    query += ' ORDER BY po.creationDate DESC';
    try {
        const [rows] = await __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["pool"].execute(query, queryParams);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(rows);
    } catch (error) {
        console.error('[API_ERROR] /api/purchase-orders GET: Error fetching purchase orders:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Failed to fetch purchase orders',
            details: error.message
        }, {
            status: 500
        });
    }
}
async function POST(request) {
    const contentType = request.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
        console.log('[API_INFO] /api/purchase-orders POST: Received application/json request.');
        let connection;
        try {
            const poData = await request.json();
            const { poNumber, creationDate, creatorUserId, requestedByName, supplierId, approverId, /* siteId, */ status, subTotal, vatAmount, grandTotal, currency, pricesIncludeVat, notes, items, selectedRequisitionId } = poData;
            connection = await __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["pool"].getConnection();
            await connection.beginTransaction();
            const finalCreatorUserId = creatorUserId || null;
            // const finalSiteId = siteId ? Number(siteId) : null; // Removed finalSiteId, PO header siteId will be NULL
            const [poResult] = await connection.execute(`INSERT INTO PurchaseOrder (poNumber, creationDate, creatorUserId, requestedByName, supplierId, approverId, siteId, status, subTotal, vatAmount, grandTotal, currency, pricesIncludeVat, notes)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`, [
                poNumber,
                new Date(creationDate),
                finalCreatorUserId,
                requestedByName,
                supplierId,
                approverId,
                null,
                status,
                subTotal,
                vatAmount,
                grandTotal,
                currency,
                pricesIncludeVat,
                notes
            ] // siteId set to null
            );
            const newPoId = poResult.insertId;
            if (items && items.length > 0) {
                for (const item of items){
                    await connection.execute(`INSERT INTO POItem (poId, partNumber, description, categoryId, siteId, uom, quantity, unitPrice, quantityReceived, itemStatus)
             VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`, [
                        newPoId,
                        item.partNumber,
                        item.description,
                        item.categoryId,
                        item.siteId || null,
                        item.uom,
                        Number(item.quantity),
                        Number(item.unitPrice),
                        item.quantityReceived || 0,
                        item.itemStatus || 'Pending'
                    ]);
                }
            }
            if (selectedRequisitionId) {
                console.log(`[API_INFO] PO created from Requisition ID: ${selectedRequisitionId}. Attempting to update Requisition status.`);
                const [updateReqResult] = await connection.execute('UPDATE Requisition SET status = ? WHERE id = ? AND status = ?', [
                    'Closed',
                    selectedRequisitionId,
                    'Approved'
                ] // Mark as 'Closed', ensure it was 'Approved'
                );
                if (updateReqResult.affectedRows > 0) {
                    console.log(`[API_INFO] Requisition ID ${selectedRequisitionId} status updated to 'Closed'.`);
                } else {
                    console.warn(`[API_WARN] Failed to update Requisition ID ${selectedRequisitionId} status to 'Closed', or it was not in 'Approved' state.`);
                }
            }
            await connection.commit();
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Purchase order created successfully',
                poId: newPoId,
                poNumber: poNumber
            }, {
                status: 201
            });
        } catch (dbError) {
            if (connection) {
                await connection.rollback();
            }
            console.error('[API_ERROR] /api/purchase-orders POST JSON: Error creating purchase order:', dbError);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to create purchase order due to a server error.',
                details: dbError.message
            }, {
                status: 500
            });
        } finally{
            if (connection) {
                connection.release();
            }
        }
    } else if (contentType && contentType.includes('multipart/form-data')) {
        console.log('[API_INFO] /api/purchase-orders POST: Received multipart/form-data request for CSV upload.');
        let connection;
        try {
            const formData = await request.formData();
            const file = formData.get('file');
            if (!file || typeof file === 'string') {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'No file uploaded or invalid file type'
                }, {
                    status: 400
                });
            }
            const fileBuffer = Buffer.from(await file.arrayBuffer());
            const results = [];
            const stream = __TURBOPACK__imported__module__$5b$externals$5d2f$stream__$5b$external$5d$__$28$stream$2c$__cjs$29$__["Readable"].from(fileBuffer);
            await new Promise((resolve, reject)=>{
                stream.pipe((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$csv$2d$parser$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
                    mapHeaders: ({ header })=>header.trim().toLowerCase()
                })).on('data', (data)=>results.push(data)).on('end', resolve).on('error', reject);
            });
            if (results.length === 0) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    message: 'Purchase Order CSV file is empty or could not be parsed.'
                }, {
                    status: 400
                });
            }
            const posGroupedByNumber = results.reduce((acc, row)=>{
                const poNumber = row.ponumber?.trim();
                if (!poNumber) return acc;
                if (!acc[poNumber]) acc[poNumber] = [];
                acc[poNumber].push(row);
                return acc;
            }, {});
            connection = await __TURBOPACK__imported__module__$5b$project$5d2f$backend$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["pool"].getConnection();
            const [suppliers] = await connection.execute('SELECT supplierCode FROM Supplier');
            const [approvers] = await connection.execute('SELECT id FROM Approver');
            const [categories] = await connection.execute('SELECT id FROM Category');
            const [sites] = await connection.execute('SELECT id FROM Site');
            const supplierSet = new Set(suppliers.map((s)=>s.supplierCode));
            const approverSet = new Set(approvers.map((a)=>a.id));
            const categorySet = new Set(categories.map((c)=>c.id));
            const siteSet = new Set(sites.map((s)=>s.id));
            let successfulImports = 0;
            let failedImports = 0;
            const errors = [];
            await connection.beginTransaction();
            for(const poNumber in posGroupedByNumber){
                const poItems = posGroupedByNumber[poNumber];
                const headerRow = poItems[0];
                try {
                    const supplierCode = headerRow.suppliercode?.trim();
                    const approverId = headerRow.approverid?.trim();
                    const poDate = headerRow.podate?.trim();
                    const notes = headerRow.overallnotes?.trim();
                    const pricesIncludeVatValue = String(headerRow.pricesincludevat || '0').toLowerCase().trim();
                    if (!supplierSet.has(supplierCode)) {
                        throw new Error(`Supplier Code '${supplierCode}' does not exist.`);
                    }
                    if (approverId && !approverSet.has(approverId)) {
                        throw new Error(`Approver ID '${approverId}' does not exist.`);
                    }
                    let subTotal = 0;
                    for (const item of poItems){
                        const qty = parseFloat(item.itemquantity?.trim());
                        const price = parseFloat(item.itemunitprice?.trim());
                        if (isNaN(qty) || isNaN(price)) {
                            throw new Error(`Invalid quantity or unit price for an item in PO ${poNumber}.`);
                        }
                        subTotal += qty * price;
                    }
                    const pricesIncludeVat = [
                        'true',
                        '1',
                        'yes'
                    ].includes(pricesIncludeVatValue);
                    let vatAmount = 0;
                    if (headerRow.currency?.trim() === 'MZN' && !pricesIncludeVat) {
                        vatAmount = subTotal * 0.16;
                    }
                    const grandTotal = subTotal + vatAmount;
                    const poInsertQuery = `
            INSERT INTO PurchaseOrder (poNumber, creationDate, creatorUserId, requestedByName, supplierId, approverId, siteId, status, subTotal, vatAmount, grandTotal, currency, pricesIncludeVat, notes)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `;
                    const [poResult] = await connection.execute(poInsertQuery, [
                        poNumber,
                        poDate ? new Date(poDate) : new Date(),
                        null,
                        headerRow.requestedbyname?.trim() || null,
                        supplierCode || null,
                        approverId || null,
                        null,
                        headerRow.status?.trim() || 'Approved',
                        subTotal,
                        vatAmount,
                        grandTotal,
                        headerRow.currency?.trim() || 'MZN',
                        pricesIncludeVat,
                        notes || null
                    ]);
                    const newPoId = poResult.insertId;
                    for (const item of poItems){
                        const categoryId = item.itemcategoryid ? parseInt(item.itemcategoryid.trim(), 10) : null;
                        const siteId = item.itemsiteid ? parseInt(item.itemsiteid.trim(), 10) : null;
                        if (categoryId && !categorySet.has(categoryId)) {
                            throw new Error(`Item in PO ${poNumber} has an invalid Category ID: ${categoryId}`);
                        }
                        if (siteId && !siteSet.has(siteId)) {
                            throw new Error(`Item in PO ${poNumber} has an invalid Site ID: ${siteId}`);
                        }
                        const itemInsertQuery = `
              INSERT INTO POItem (poId, partNumber, description, categoryId, siteId, uom, quantity, unitPrice)
              VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            `;
                        await connection.execute(itemInsertQuery, [
                            newPoId,
                            item.itempartnumber?.trim() || null,
                            item.itemdescription?.trim() || 'N/A',
                            categoryId,
                            siteId,
                            item.itemuom?.trim() || 'EA',
                            parseFloat(item.itemquantity?.trim()) || 0,
                            parseFloat(item.itemunitprice?.trim()) || 0
                        ]);
                    }
                    successfulImports++;
                } catch (error) {
                    failedImports++;
                    errors.push(`Failed to import PO ${poNumber}: ${error.message}`);
                }
            }
            if (failedImports > 0) {
                await connection.rollback();
                console.warn(`[API_WARN] PO CSV Upload: Rolled back transaction due to ${failedImports} errors.`, errors);
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    message: `Processing complete. ${successfulImports} POs were valid but the transaction was rolled back due to ${failedImports} errors. Please fix the CSV and re-upload.`,
                    errors: errors
                }, {
                    status: 400
                });
            } else {
                await connection.commit();
                console.log(`[API_INFO] PO CSV Upload: Transaction committed successfully for ${successfulImports} POs.`);
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    message: `Successfully imported ${successfulImports} Purchase Orders and their items into the database.`
                }, {
                    status: 200
                });
            }
        } catch (error) {
            if (connection) await connection.rollback();
            console.error('[API_ERROR] /api/purchase-orders POST CSV: Error handling purchase order file upload:', error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to handle purchase order file upload',
                details: error.message
            }, {
                status: 500
            });
        } finally{
            if (connection) connection.release();
        }
    } else {
        console.warn(`[API_WARN] /api/purchase-orders POST: Unsupported Content-Type: ${contentType}`);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Unsupported Content-Type'
        }, {
            status: 415
        });
    }
}
}}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__d3fe0d45._.js.map