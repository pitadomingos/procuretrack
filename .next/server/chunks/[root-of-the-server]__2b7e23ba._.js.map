{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 62, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/api/purchase-orders/%5BpoId%5D/route.js"],"sourcesContent":["\nimport { NextResponse } from 'next/server';\n\nexport async function GET(request, { params }) {\n  const { poId } = params;\n  let connection;\n  try {\n    const { pool } = await import('../../../../../backend/db.js');\n    connection = await pool.getConnection();\n    // Selecting all columns, including siteId from PurchaseOrder table\n    const [rows] = await connection.execute('SELECT * FROM PurchaseOrder WHERE id = ?', [poId]);\n    if (rows.length > 0) {\n      return NextResponse.json(rows[0]);\n    } else {\n      return NextResponse.json({ message: `Purchase order with ID ${poId} not found` }, { status: 404 });\n    }\n  } catch (error) {\n    console.error(`Error fetching purchase order with ID ${poId}:`, error);\n    return NextResponse.json({ error: `Failed to fetch purchase order with ID ${poId}` }, { status: 500 });\n  } finally {\n      if (connection) connection.release();\n  }\n}\n\nexport async function PUT(request, { params }) {\n  const { poId } = params;\n  const numericPoId = Number(poId);\n\n  if (isNaN(numericPoId)) {\n    return NextResponse.json({ error: 'Invalid Purchase Order ID' }, { status: 400 });\n  }\n\n  let connection;\n  try {\n    const { pool } = await import('../../../../../backend/db.js');\n    const poData = await request.json();\n    const {\n      poNumber,\n      creationDate,\n      requestedByName,\n      supplierId,\n      approverId,\n      siteId, // Added overall PO siteId\n      subTotal,\n      vatAmount,\n      grandTotal,\n      currency,\n      pricesIncludeVat,\n      notes,\n      items \n    } = poData;\n\n    connection = await pool.getConnection();\n    await connection.beginTransaction();\n\n    const finalSiteId = siteId ? Number(siteId) : null; // Ensure siteId is number or null\n\n    const [poUpdateResult] = await connection.execute(\n      `UPDATE PurchaseOrder SET \n        poNumber = ?, creationDate = ?, requestedByName = ?, supplierId = ?, approverId = ?, siteId = ?,\n        subTotal = ?, vatAmount = ?, grandTotal = ?, currency = ?, pricesIncludeVat = ?, notes = ?\n       WHERE id = ?`, // Added siteId to SET clause\n      [\n        poNumber, new Date(creationDate), requestedByName, supplierId, approverId, finalSiteId,\n        subTotal, vatAmount, grandTotal, currency, pricesIncludeVat, notes,\n        numericPoId\n      ]\n    );\n\n    if (poUpdateResult.affectedRows === 0) {\n      await connection.rollback();\n      return NextResponse.json({ error: `Purchase Order with ID ${numericPoId} not found for update.` }, { status: 404 });\n    }\n\n    await connection.execute('DELETE FROM POItem WHERE poId = ?', [numericPoId]);\n\n    if (items && items.length > 0) {\n      for (const item of items) {\n        await connection.execute(\n          `INSERT INTO POItem (poId, partNumber, description, categoryId, siteId, uom, quantity, unitPrice, quantityReceived, itemStatus)\n           VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,\n          [\n            numericPoId, \n            item.partNumber || null, \n            item.description, \n            item.categoryId ? Number(item.categoryId) : null, \n            item.siteId ? Number(item.siteId) : null, // Item-level siteId\n            item.uom, \n            Number(item.quantity), \n            Number(item.unitPrice),\n            item.quantityReceived || 0, \n            item.itemStatus || 'Pending'   \n          ]\n        );\n      }\n    }\n\n    await connection.commit();\n    return NextResponse.json({ message: 'Purchase order updated successfully', poId: numericPoId, poNumber: poNumber });\n\n  } catch (dbError) {\n    if (connection) {\n      await connection.rollback();\n    }\n    console.error(`Error updating purchase order ${numericPoId}:`, dbError);\n    const errorMessage = dbError instanceof Error ? dbError.message : String(dbError);\n    return NextResponse.json({ error: 'Failed to update purchase order.', details: errorMessage }, { status: 500 });\n  } finally {\n    if (connection) {\n      connection.release();\n    }\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}